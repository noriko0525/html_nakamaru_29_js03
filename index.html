<!DOCTYPE html>
<html lang="jp">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="js/jquery-2.1.3.min.js"></script>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/reset.css">
    <title>第3回目課題</title>
</head>
<body>
<div id="wrapper">
    <div id="mydata">
        <div id="name">
            <input type="text" id="uname" placeholder="お名前">
            <i class="fa fa-user fa-lg fa-fw" aria-hidden="true"></i>
        </div>
        <div id="icon">
            <ul>
                <li class="img" data-img="0"><img src="img/tanjiro.png" width="50"></li>
                <li class="img" data-img="1"><img src="img/nezuko.png" width="50"></li>
                <li class="img" data-img="2"><img src="img/zenitsu.png" width="50"></li>
                <li class="img" data-img="3"><img src="img/inosuke.png" width="50"></li>
                <li class="img" data-img="4"><img src="img/tomioka.png" width="50"></li>
            </ul>
        </div>
    </div>
    <div id="chat_view">
        <div id="output"></div>
    </div>
    <div id="chat_input">
        <textarea id="text" cols="30" rows="2"></textarea><button id="send">送信</button>
    </div>
</div>


<!-- 以下Firebase -->
<!-- The core Firebase JS SDK is always required and must be listed first -->
<script src="https://www.gstatic.com/firebasejs/7.20.0/firebase.js"></script>

<!-- TODO: Add SDKs for Firebase products that you want to use
     https://firebase.google.com/docs/web/setup#available-libraries -->

<script>
  // Your web app's Firebase configuration
  var firebaseConfig = {
    apiKey: "AIzaSyAyDzWcjN-zVc0p2Kz2eLla5yBREK6d-7A",
    authDomain: "dev17-95585.firebaseapp.com",
    databaseURL: "https://dev17-95585.firebaseio.com",
    projectId: "dev17-95585",
    storageBucket: "dev17-95585.appspot.com",
    messagingSenderId: "437993499620",
    appId: "1:437993499620:web:c9c62f09d24f49120675f1"
  };
// Initialize Firebase
  firebase.initializeApp(firebaseConfig);
//   変数設定
  const ref = firebase.database().ref();
$(function(){
//アイコン処理
    let d=0;
    let img = ["tanjiro.png","nezuko.png","zenitsu.png","inosuke.png","tomioka.png"];
    $('.img').on('click',function(){
        d = $(this).attr("data-img");
        console.log($(this).html());
        })
// ボタンclickとEnterで送信
    $("#text").keyup(function(e){
        if(e.keyCode == 13){
            if($("#uname").val() == ""){
                alert("名前を入力してください")
                return false;
            }else{;
            inputText()
        };
    }
    })
    $("#send").on("click",function(e){
        inputText()
    });
//送信処理
    function inputText(){
        const uname = $("#uname").val();
        const text = $("#text").val();
        const msg = {
            uname : uname,
            text : text,
            icon :d
        };
        ref.push(msg);
        $('#text').val("");
        const lastElement = document.querySelector("#output").lastElementChild//最後の要素を取得
        lastElement.scrollIntoView({behavior: "smooth"})//最後の要素が見えるまでスクロール
        localStorage.setItem('name',uname);
    }
//受信
    ref.limitToLast(10).on("child_added",function(data){
        const v = data.val();
        const k = v.uname;
        const m = v.text;
        if (k == $('#uname').val()){
            const h = '<div class=" mydata"><span class="chat_img"><img src="img/'+img[v.icon]+'" width="30"><span class="name">'+v.uname+'</span></span><span class="chat_txt">'+v.text+'</span></div>';
            $("#output").append(h);
        }else{
            const h = '<div class="yourdata"><span class="chat_img"><img src="img/'+img[v.icon]+'" width="30"><span class="name">'+v.uname+'</span></span><span class="chat_txt">'+v.text+'</span></div>';
            $("#output").append(h);
        }
        const lastElement = document.querySelector("#output").lastElementChild//最後の要素を取得
        lastElement.scrollIntoView({behavior: "smooth"})//最後の要素が見えるまでスクロール
    })
//リロード
$(function (){
    var preNameData = localStorage.getItem("name");
    $('#uname').val(preNameData);
});
});

</script> 
</body>
</html>